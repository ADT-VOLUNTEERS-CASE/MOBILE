name: Roborazzi Compose Preview

on:
  pull_request:
    paths:
      - 'presentation/src/main/kotlin/org/adt/presentation/screens/**'
      - 'presentation/src/main/kotlin/org/adt/presentation/composable/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  roborazzi-preview:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Detect changed files
        id: changed-files
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          # Filter for composable and screens directories
          COMPOSABLE_CHANGES=$(echo "$CHANGED_FILES" | grep -E '(screens/|composable/)' || echo "")
          
          if [ -z "$COMPOSABLE_CHANGES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes in composable or screens directories"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed composable/screens files:"
            echo "$COMPOSABLE_CHANGES"
          fi

      - name: Run recordRoborazziDebug task
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          ./gradlew presentation:recordRoborazziDebug --stacktrace

      - name: Find generated preview images
        if: steps.changed-files.outputs.has_changes == 'true'
        id: find-images
        run: |
          IMAGES_DIR="presentation/build/outputs/roborazzi"
          
          if [ -d "$IMAGES_DIR" ]; then
            # Find all PNG files
            IMAGES=$(find "$IMAGES_DIR" -name "*.png" -type f | sort)
            
            if [ -z "$IMAGES" ]; then
              echo "image_count=0" >> $GITHUB_OUTPUT
              echo "No PNG files found in $IMAGES_DIR"
            else
              # Count images
              COUNT=$(echo "$IMAGES" | wc -l)
              echo "image_count=$COUNT" >> $GITHUB_OUTPUT
              echo "Found $COUNT preview images"
              echo "$IMAGES"
            fi
          else
            echo "image_count=0" >> $GITHUB_OUTPUT
            echo "Directory $IMAGES_DIR not found"
          fi

      - name: Generate PR comment with previews
        if: steps.changed-files.outputs.has_changes == 'true' && steps.find-images.outputs.image_count != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const IMAGES_DIR = 'presentation/build/outputs/roborazzi';
            
            // Get all PNG files
            const files = fs.readdirSync(IMAGES_DIR)
              .filter(file => file.endsWith('.png'))
              .sort();
            
            if (files.length === 0) {
              console.log('No PNG files found');
              return;
            }
            
            // Group images by test/screen name
            const groupedImages = {};
            files.forEach(file => {
              // Extract screen name from filename
              // Example: org.adt.presentation.screens.example.ExampleScreenKt.ExampleScreenPreview.WITH_BACKGROUND.png
              const match = file.match(/^(.+?)\.([^.]+)\.png$/);
              if (match) {
                const baseName = match[1];
                const variant = match[2];
                
                if (!groupedImages[baseName]) {
                  groupedImages[baseName] = [];
                }
                groupedImages[baseName].push({
                  variant: variant,
                  file: file,
                  path: path.join(IMAGES_DIR, file)
                });
              }
            });
            
            // Build comment body
            let commentBody = '##Roborazzi Preview\n\n';
            commentBody += `Found **${files.length}** preview image(s) from modified composables.\n\n`;
            
            Object.entries(groupedImages).forEach(([screenName, images]) => {
              const displayName = screenName
                .split('.')
                .slice(-2)
                .join('.');
              
              commentBody += `### ${displayName}\n\n`;
              
              images.forEach(img => {
                commentBody += `<details>\n`;
                commentBody += `<summary>${img.variant}</summary>\n\n`;
                
                const imageBuffer = fs.readFileSync(img.path);
                const base64Image = imageBuffer.toString('base64');
                
                commentBody += `![${img.file}](data:image/png;base64,${base64Image})\n\n`;
                commentBody += `</details>\n\n`;
              });
            });
            
            commentBody += '---\n';
            commentBody += '_Generated by Roborazzi CI/CD workflow_\n';
            
            // Find existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Roborazzi Preview Screenshots')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
              console.log('Updated existing comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
              console.log('Created new comment');
            }

      - name: No changes message
        if: steps.changed-files.outputs.has_changes == 'false'
        run: |
          echo "No changes detected in screens/** or composable/** directories"
          echo "Skipping Roborazzi preview generation"